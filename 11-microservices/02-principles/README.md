# Домашнее задание к занятию «Микросервисы: принципы»

## Задача 
<details> <summary> . </summary>

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры. Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: API Gateway
Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

Решение должно соответствовать следующим требованиям:

маршрутизация запросов к нужному сервису на основе конфигурации,
возможность проверки аутентификационной информации в запросах,
обеспечение терминации HTTPS.
Обоснуйте свой выбор.

## Задача 2: Брокер сообщений
Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.

Решение должно соответствовать следующим требованиям:

поддержка кластеризации для обеспечения надёжности,
хранение сообщений на диске в процессе доставки,
высокая скорость работы,
поддержка различных форматов сообщений,
разделение прав доступа к различным потокам сообщений,
простота эксплуатации.
Обоснуйте свой выбор.

## Задача 3: API Gateway * (необязательная)
Есть три сервиса:
minio

хранит загруженные файлы в бакете images,
S3 протокол,
uploader

принимает файл, если картинка сжимает и загружает его в minio,
POST /v1/upload,
security

регистрация пользователя POST /v1/user,
получение информации о пользователе GET /v1/user,
логин пользователя POST /v1/token,
проверка токена GET /v1/token/validation.
Необходимо воспользоваться любым балансировщиком и сделать API Gateway:
POST /v1/register

Анонимный доступ.
Запрос направляется в сервис security POST /v1/user.
POST /v1/token

Анонимный доступ.
Запрос направляется в сервис security POST /v1/token.
GET /v1/user

Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
Запрос направляется в сервис security GET /v1/user.
POST /v1/upload

Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
Запрос направляется в сервис uploader POST /v1/upload.
GET /v1/user/{image}

Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
Запрос направляется в сервис minio GET /images/{image}.
Ожидаемый результат
Результатом выполнения задачи должен быть docker compose файл, запустив который можно локально выполнить следующие команды с успешным результатом. Предполагается, что для реализации API Gateway будет написан конфиг для NGinx или другого балансировщика нагрузки, который будет запущен как сервис через docker-compose и будет обеспечивать балансировку и проверку аутентификации входящих запросов. Авторизация curl -X POST -H 'Content-Type: application/json' -d '{"login":"bob", "password":"qwe123"}' http://localhost/token

Загрузка файла

curl -X POST -H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJib2IifQ.hiMVLmssoTsy1MqbmIoviDeFPvo-nCd92d4UFiN2O2I' -H 'Content-Type: octet/stream' --data-binary @yourfilename.jpg http://localhost/upload

Получение файла curl -X GET http://localhost/images/4e6df220-295e-4231-82bc-45e4b1484430.jpg

</details>
#

> ### Решение:
>

#
1. 
Для решения задачи подходят следующие продукты:

| Решение            | Маршрутизация | Аутентификация | Терминация HTTPS | Бесплатно/Открыто?                                               |
|--------------------|---------------|----------------|------------------|------------------------------------------------------------------|
| Kong Gateway       | +             | +              | +                | Бесплатно, Apache 2.0                                            |
| Tyk.io             | +             | +              | +                | Бесплатно, MPL                                                   |
| HAProxy            | +             | +              | +                | Бесплатно                                                        |
| Yandex API Gateway | +             | +              | +                | Платно                                                           |
| Azure API Gateway  | +             | +              | +                | Платно                                                           |
| NGINX              | +             | +              | +                | Бесплатно                                                        |
| KrakenD            | +             | +              | +                | Двойное лицензирование, нужные функции частично в платной версии |

По функционалу подходят все варианты. Для небольшого проекта целесообразно использовать облачные API Gateway, например от Яндекса (есть бесплатный объём). Если требуется развернуть API Gateway на своём железе, то нормальных вариантов также хватает. 

Преимущества облачных API Gateway:
Удобны в использовании и значительно экономят время разработки, легко настраиваются. Позволяют выполнять контроль различных показателей, показывая в удобном интерфейсе, например, число ошибок или задержку вызова.

Преимущества локальных API Gateway:
Развертывание локальных шлюзов в тех же средах, где реализованы API серверной части, позволяет передавать трафик API непосредственно в API серверной части, что дает возможность сократить задержку, оптимизировать затраты на передачу данных и обеспечить соответствие требованиям.

- Наиболее оптимальным решением для реализации API Gateway будет использование NGINX - популярное бесплатное решение, Данное решение будет отвечать за маршрутизацию и сопутствующие конфиги, а в связке с OpenIG можно будет тонко настроить контроль авторизации и аутентификации запросов. Данный продукт с большим сообществом (можно найти достаточно различных схем реализации API Gateway). 
 
Еще можно рассмотреть HAProxy, как более быстрая и универсальная альтернатива.

#
2. 